------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
util.AddNetworkString("AFKWarning")
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
util.AddNetworkString("AFKAnnounce")
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
function AFKKicker:WarnPlayer(ply)
    net.Start("AFKWarning")
    net.WriteBool(true)
    net.Send(ply)
    ply.HasWarning = true
end

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
function AFKKicker:RemoveWarning(ply)
    net.Start("AFKWarning")
    net.WriteBool(false)
    net.Send(ply)
    ply.HasWarning = false
end

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
function AFKKicker:CharKick(ply)
    net.Start("AFKAnnounce")
    net.WriteString(ply:Nick())
    net.Broadcast()
    self:ResetAFKTime(ply)
    timer.Simple(1 + (ply:Ping() / 1000), function() ply:getChar():kick() end)
end

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
function AFKKicker:ResetAFKTime(ply)
    ply.AFKTime = 0
    if ply.HasWarning then self:RemoveWarning(ply) end
end

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
function AFKKicker:PlayerButtonUp(ply)
    self:ResetAFKTime(ply)
end

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
function AFKKicker:PlayerButtonDown(ply)
    self:ResetAFKTime(ply)
end

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
timer.Create(
    "AFKTimer",
    AFKKicker.TimerInterval,
    0,
    function()
        local plyCount = player.GetCount()
        local maxPlayers = game.MaxPlayers()
        for _, ply in ipairs(player.GetAll()) do
            if not ply:getChar() and plyCount < maxPlayers then continue end
            if table.HasValue(AFKKicker.AFKAllowedPlayers, ply:SteamID64()) or ply:IsBot() then continue end
            ply.AFKTime = (ply.AFKTime or 0) + AFKKicker.TimerInterval
            if ply.AFKTime >= AFKKicker.WarningTime and not ply.HasWarning then AFKKicker:WarnPlayer(ply) end
            if ply.AFKTime >= AFKKicker.WarningTime + AFKKicker.KickTime then
                if plyCount >= maxPlayers then
                    ply:Kick(AFKKicker.KickMessage)
                elseif ply:getChar() then
                    AFKKicker:CharKick(ply)
                end
            end
        end
    end
)
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
